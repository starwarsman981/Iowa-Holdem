<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Iowa Hold'em</title>
<style>
  body { font-family: monospace; background: #222; color: #eee; }
  #game { max-width: 600px; margin: auto; }
  .card { display: inline-block; border: 1px solid #eee; padding: 10px; margin: 5px; border-radius: 5px; width: 40px; text-align: center; cursor: pointer; user-select: none;}
  .card.selected { background: crimson; }
  .disabled { opacity: 0.4; pointer-events: none; }
  button { margin: 5px; }
</style>
</head>
<body>
<div id="game">
  <h1>Iowa Holdâ€™em</h1>

  <input id="nameInput" placeholder="Enter your name" />

  <div id="status"></div>
  <div id="pot"></div>
  <div id="phase"></div>
  <div id="community"></div>
  <div id="players"></div>
  <div id="actions" class="disabled">
    <button id="foldBtn">Fold</button>
    <button id="checkBtn">Check</button>
    <button id="callBtn">Call</button>
    <input id="raiseAmount" type="number" min="1" placeholder="Raise amount" />
    <button id="raiseBtn">Raise</button>
    <button id="discardBtn" class="disabled">Discard Selected Card</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let myId = null;
let currentTurnId = null;
let phase = null;
let selectedDiscardIndices = [];
const ROOM_NAME = 'iowa-room';

const nameInput = document.getElementById('nameInput');
const statusDiv = document.getElementById('status');
const potDiv = document.getElementById('pot');
const phaseDiv = document.getElementById('phase');
const communityDiv = document.getElementById('community');
const playersDiv = document.getElementById('players');
const actionsDiv = document.getElementById('actions');
const foldBtn = document.getElementById('foldBtn');
const checkBtn = document.getElementById('checkBtn');
const callBtn = document.getElementById('callBtn');
const raiseAmountInput = document.getElementById('raiseAmount');
const raiseBtn = document.getElementById('raiseBtn');
const discardBtn = document.getElementById('discardBtn');

let playerName = null;

nameInput.onkeydown = (e) => {
  if (e.key === 'Enter') {
    const val = nameInput.value.trim();
    if (!val) {
      alert('Please enter a name');
      return;
    }
    playerName = val;
    socket.emit('joinRoom', { roomId: ROOM_NAME, name: playerName });
    statusDiv.textContent = `Joined room: ${ROOM_NAME} as ${playerName}`;
    nameInput.disabled = true;
  }
};

socket.on('connect', () => {
  myId = socket.id;
  console.log('Connected with id:', myId);
});

socket.on('gameState', (state) => {
  phase = state.phase;
  currentTurnId = state.turnId;
  potDiv.textContent = `Pot: ${state.pot}`;
  phaseDiv.textContent = `Phase: ${phase}`;
  renderCommunity(state.community);
  renderPlayers(state.players);
  updateActions();
});

socket.on('turn', (playerId) => {
  currentTurnId = playerId;
  updateActions();
});

socket.on('yourTurn', ({ phase: p, currentBet }) => {
  if (p === 'discard') {
    statusDiv.textContent = `Your turn! Discard exactly one card.`;
  } else {
    statusDiv.textContent = `Your turn! Phase: ${p}, Current bet to call: ${currentBet}`;
  }
});

socket.on('errorMessage', msg => {
  alert(msg);
});

socket.on('status', msg => {
  statusDiv.textContent = msg;
});

function renderCommunity(cards) {
  communityDiv.innerHTML = '<h3>Community Cards</h3>';
  cards.forEach(c => {
    const cardEl = document.createElement('div');
    cardEl.className = 'card';
    cardEl.textContent = c.rank + c.suit;
    communityDiv.appendChild(cardEl);
  });
}

function renderPlayers(players) {
  playersDiv.innerHTML = '';
  players.forEach(p => {
    const pDiv = document.createElement('div');
    pDiv.textContent = `Player ${p.name}${p.id === myId ? ' (You)' : ''} - Chips: ${p.chips} ${p.folded ? '[Folded]' : ''} Bet: ${p.bet}`;
    if (p.hand) {
      const handDiv = document.createElement('div');
      handDiv.style.margin = '5px 0';
      p.hand.forEach((card, i) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card';
        cardEl.textContent = card ? card.rank + card.suit : 'ðŸ‚ ';
        if (p.id === myId && phase && phase.endsWith('discard') && !p.folded) {
          cardEl.style.cursor = 'pointer';
          cardEl.onclick = () => toggleDiscard(i, cardEl);
        }
        handDiv.appendChild(cardEl);
      });
      pDiv.appendChild(handDiv);
    }
    playersDiv.appendChild(pDiv);
  });
}

function toggleDiscard(idx, cardEl) {
  if (selectedDiscardIndices.includes(idx)) {
    selectedDiscardIndices = selectedDiscardIndices.filter(i => i !== idx);
    cardEl.classList.remove('selected');
  } else {
    if (selectedDiscardIndices.length >= 1) {
      alert('You can only discard one card');
      return;
    }
    selectedDiscardIndices.push(idx);
    cardEl.classList.add('selected');
  }
  discardBtn.classList.toggle('disabled', selectedDiscardIndices.length === 0);
}

function updateActions() {
  if (myId === currentTurnId) {
    actionsDiv.classList.remove('disabled');
    if (phase &&
